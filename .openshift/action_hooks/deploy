#!/bin/bash

# Confirm the database exists, if not create it
if ! /usr/bin/mysql -u "$OPENSHIFT_MYSQL_DB_USERNAME" -p"$OPENSHIFT_MYSQL_DB_PASSWORD" -h "$OPENSHIFT_MYSQL_DB_HOST" -P "$OPENSHIFT_MYSQL_DB_PORT" -e "use "$OPENSHIFT_APP_NAME"" > /dev/null 2>&1
then
	echo
	echo "Database not found, creating it now."
	/usr/bin/mysql -u "$OPENSHIFT_MYSQL_DB_USERNAME" -p"$OPENSHIFT_MYSQL_DB_PASSWORD" -h "$OPENSHIFT_MYSQL_DB_HOST" -P "$OPENSHIFT_MYSQL_DB_PORT" -e "create database $OPENSHIFT_APP_NAME character set utf8 collate utf8_bin;"
	echo "Adding schema.sql"
	/usr/bin/mysql -u "$OPENSHIFT_MYSQL_DB_USERNAME" -p"$OPENSHIFT_MYSQL_DB_PASSWORD" -h "$OPENSHIFT_MYSQL_DB_HOST" -P "$OPENSHIFT_MYSQL_DB_PORT" "$OPENSHIFT_APP_NAME" < ${OPENSHIFT_DATA_DIR}zabbix-2.2.1/database/mysql/schema.sql
	echo "Adding images.sql"
	/usr/bin/mysql -u "$OPENSHIFT_MYSQL_DB_USERNAME" -p"$OPENSHIFT_MYSQL_DB_PASSWORD" -h "$OPENSHIFT_MYSQL_DB_HOST" -P "$OPENSHIFT_MYSQL_DB_PORT" "$OPENSHIFT_APP_NAME" < ${OPENSHIFT_DATA_DIR}zabbix-2.2.1/database/mysql/images.sql
	echo "Adding data.sql"
	/usr/bin/mysql -u "$OPENSHIFT_MYSQL_DB_USERNAME" -p"$OPENSHIFT_MYSQL_DB_PASSWORD" -h "$OPENSHIFT_MYSQL_DB_HOST" -P "$OPENSHIFT_MYSQL_DB_PORT" "$OPENSHIFT_APP_NAME" < ${OPENSHIFT_DATA_DIR}zabbix-2.2.1/database/mysql/data.sql
else
	echo "Database already configured."
fi

# Configure 
echo 
echo "Configuring Zabbix Server"
echo "ListenPort=15051" >> ${OPENSHIFT_DATA_DIR}zabbix/etc/zabbix_server.conf
echo "ListenIP=${OPENSHIFT_PHP_IP}" >> ${OPENSHIFT_DATA_DIR}zabbix/etc/zabbix_server.conf
echo
echo "Configuring Zabbix Agent"
echo "Server=${OPENSHIFT_PHP_IP}" >> ${OPENSHIFT_DATA_DIR}zabbix/etc/zabbix_agentd.conf
echo "ListenPort=15050" >> ${OPENSHIFT_DATA_DIR}zabbix/etc/zabbix_agentd.conf
echo "ListenIP=${OPENSHIFT_PHP_IP}" >> ${OPENSHIFT_DATA_DIR}zabbix/etc/zabbix_agentd.conf
echo "ServerActive=${OPENSHIFT_PHP_IP}:15051" >> ${OPENSHIFT_DATA_DIR}zabbix/etc/zabbix_agentd.conf
echo "SourceIP=${OPENSHIFT_PHP_IP}" >> ${OPENSHIFT_DATA_DIR}zabbix/etc/zabbix_agentd.conf


